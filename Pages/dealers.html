<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NDMA Portal - Dealers</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        window.FontAwesomeConfig = {
            autoReplaceSvg: 'nest', // Options: 'nest', 'remove', 'replace'
        };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


    <!-- Import the CSS files -->
    <link rel="stylesheet" href="../styles/components.css">

    <script src="../logo.js"></script>
    <style>
        * {
            font-family: "Inter", sans-serif;
        }

        ::-webkit-scrollbar {
            display: none;
        }
    </style>

    
<style>

        .container1 {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-top:20px;
            margin-bottom:20px;
            padding: 20px;


        }

       .filters-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.9rem;
        }

        .filter-group select {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            transition: border-color 0.3s ease;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #4CAF50;
        }
        .color{
            color: #4CAF50;
        }

        .search-button {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease;
            margin-top: 20px;
        }

        .search-button:hover {
            transform: translateY(-2px);
        }

        .results-section {
            padding: 30px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .results-count {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }
        

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            font-size: 1.1rem;
        }

        .loading::before {
            content: "üîÑ";
            display: block;
            font-size: 3rem;
            margin-bottom: 20px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .dealers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .dealer-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid #e9ecef;
        }

        .dealer-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .dealer-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .dealer-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.5rem;
        }

        .dealer-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }

        .dealer-type {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
        }

        .dealer-info {
            margin-top: 15px;
        }

        .info-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #666;
        }

        .info-icon {
            margin-right: 10px;
            width: 16px;
            text-align: center;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 40px;
        }

        .pagination button {
            padding: 12px 20px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .pagination button:hover:not(:disabled) {
            border-color: #4CAF50;
            background: #4CAF50;
            color: white;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .current-page {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .no-results::before {
            content: "üì≠";
            display: block;
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .retry-button {
            background: #ff9800;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .dealers-grid {
                grid-template-columns: 1fr;
            }
            
            .results-header {
                flex-direction: column;
                align-items: stretch;
            }
        }
    .highlighted-section {
    outline: 2px solid #3F20FB;
    background-color: rgba(63, 32, 251, 0.1);
    }

    .edit-button {
    position: absolute;
    z-index: 1000;
    }
    .edit-button {
    position: absolute;
    z-index: 1000;
    }
    @keyframes fade-up {
  0% {
    opacity: 0;
    transform: translateY(20px);
  }
  100% {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-fade-up {
  animation: fade-up 1s ease-out both;
}

    
</style>
    
<script>
  
        tailwind.config = {
            theme: {
            extend: {
                colors: {
                ...{"transparent":"transparent","current":"currentColor","black":"#000000","white":"#ffffff","gray":{"50":"#f9fafb","100":"#f3f4f6","200":"#e5e7eb","300":"#d1d5db","400":"#9ca3af","500":"#6b7280","600":"#4b5563","700":"#374151","800":"#1f2937","900":"#111827"},"red":{"50":"#fef2f2","100":"#fee2e2","200":"#fecaca","300":"#fca5a5","400":"#f87171","500":"#ef4444","600":"#dc2626","700":"#b91c1c","800":"#991b1b","900":"#7f1d1d"},"yellow":{"50":"#fffbeb","100":"#fef3c7","200":"#fde68a","300":"#fcd34d","400":"#fbbf24","500":"#f59e0b","600":"#d97706","700":"#b45309","800":"#92400e","900":"#78350f"},"green":{"50":"#ecfdf5","100":"#d1fae5","200":"#a7f3d0","300":"#6ee7b7","400":"#34d399","500":"#10b981","600":"#059669","700":"#047857","800":"#065f46","900":"#064e3b"},"blue":{"50":"#eff6ff","100":"#dbeafe","200":"#bfdbfe","300":"#93c5fd","400":"#60a5fa","500":"#3b82f6","600":"#2563eb","700":"#1d4ed8","800":"#1e40af","900":"#1e3a8a"},"indigo":{"50":"#eef2ff","100":"#e0e7ff","200":"#c7d2fe","300":"#a5b4fc","400":"#818cf8","500":"#6366f1","600":"#4f46e5","700":"#4338ca","800":"#3730a3","900":"#312e81"},"purple":{"50":"#f5f3ff","100":"#ede9fe","200":"#ddd6fe","300":"#c4b5fd","400":"#a78bfa","500":"#8b5cf6","600":"#7c3aed","700":"#6d28d9","800":"#5b21b6","900":"#4c1d95"},"pink":{"50":"#fdf2f8","100":"#fce7f3","200":"#fbcfe8","300":"#f9a8d4","400":"#f472b6","500":"#ec4899","600":"#db2777","700":"#be185d","800":"#9d174d","900":"#831843"}},
                ...{"primary":{"50":"var(--color-primary-50)","100":"var(--color-primary-100)","200":"var(--color-primary-200)","300":"var(--color-primary-300)","400":"var(--color-primary-400)","500":"var(--color-primary-500)","600":"var(--color-primary-600)","700":"var(--color-primary-700)","800":"var(--color-primary-800)","900":"var(--color-primary-900)","DEFAULT":"var(--color-primary)","focus":"var(--color-primary-focus)","content":"var(--color-primary-content)"},"secondary":{"50":"var(--color-secondary-50)","100":"var(--color-secondary-100)","200":"var(--color-secondary-200)","300":"var(--color-secondary-300)","400":"var(--color-secondary-400)","500":"var(--color-secondary-500)","600":"var(--color-secondary-600)","700":"var(--color-secondary-700)","800":"var(--color-secondary-800)","900":"var(--color-secondary-900)","DEFAULT":"var(--color-secondary)","focus":"var(--color-secondary-focus)","content":"var(--color-secondary-content)"},"accent":{"50":"var(--color-accent-50)","100":"var(--color-accent-100)","200":"var(--color-accent-200)","300":"var(--color-accent-300)","400":"var(--color-accent-400)","500":"var(--color-accent-500)","600":"var(--color-accent-600)","700":"var(--color-accent-700)","800":"var(--color-accent-800)","900":"var(--color-accent-900)","DEFAULT":"var(--color-accent)","focus":"var(--color-accent-focus)","content":"var(--color-accent-content)"},"neutral":{"50":"var(--color-neutral-50)","100":"var(--color-neutral-100)","200":"var(--color-neutral-200)","300":"var(--color-neutral-300)","400":"var(--color-neutral-400)","500":"var(--color-neutral-500)","600":"var(--color-neutral-600)","700":"var(--color-neutral-700)","800":"var(--color-neutral-800)","900":"var(--color-neutral-900)","DEFAULT":"var(--color-neutral)","focus":"var(--color-neutral-focus)","content":"var(--color-neutral-content)"},"info":{"50":"var(--color-info-50)","100":"var(--color-info-100)","200":"var(--color-info-200)","300":"var(--color-info-300)","400":"var(--color-info-400)","500":"var(--color-info-500)","600":"var(--color-info-600)","700":"var(--color-info-700)","800":"var(--color-info-800)","900":"var(--color-info-900)","DEFAULT":"var(--color-info)","focus":"var(--color-info-focus)","content":"var(--color-info-content)"},"success":{"50":"var(--color-success-50)","100":"var(--color-success-100)","200":"var(--color-success-200)","300":"var(--color-success-300)","400":"var(--color-success-400)","500":"var(--color-success-500)","600":"var(--color-success-600)","700":"var(--color-success-700)","800":"var(--color-success-800)","900":"var(--color-success-900)","DEFAULT":"var(--color-success)","focus":"var(--color-success-focus)","content":"var(--color-success-content)"},"warning":{"50":"var(--color-warning-50)","100":"var(--color-warning-100)","200":"var(--color-warning-200)","300":"var(--color-warning-300)","400":"var(--color-warning-400)","500":"var(--color-warning-500)","600":"var(--color-warning-600)","700":"var(--color-warning-700)","800":"var(--color-warning-800)","900":"var(--color-warning-900)","DEFAULT":"var(--color-warning)","focus":"var(--color-warning-focus)","content":"var(--color-warning-content)"},"error":{"50":"var(--color-error-50)","100":"var(--color-error-100)","200":"var(--color-error-200)","300":"var(--color-error-300)","400":"var(--color-error-400)","500":"var(--color-error-500)","600":"var(--color-error-600)","700":"var(--color-error-700)","800":"var(--color-error-800)","900":"var(--color-error-900)","DEFAULT":"var(--color-error)","focus":"var(--color-error-focus)","content":"var(--color-error-content)"},"danger":{"50":"var(--color-error-50)","100":"var(--color-error-100)","200":"var(--color-error-200)","300":"var(--color-error-300)","400":"var(--color-error-400)","500":"var(--color-error-500)","600":"var(--color-error-600)","700":"var(--color-error-700)","800":"var(--color-error-800)","900":"var(--color-error-900)","DEFAULT":"var(--color-error)","focus":"var(--color-error-focus)","content":"var(--color-error-content)"},"failure":{"50":"var(--color-error-50)","100":"var(--color-error-100)","200":"var(--color-error-200)","300":"var(--color-error-300)","400":"var(--color-error-400)","500":"var(--color-error-500)","600":"var(--color-error-600)","700":"var(--color-error-700)","800":"var(--color-error-800)","900":"var(--color-error-900)","DEFAULT":"var(--color-error)","focus":"var(--color-error-focus)","content":"var(--color-error-content)"}},
                },
            },
            },
            variants: {
            extend: {
                backgroundColor: ['active', 'group-hover'],
                textColor: ['active', 'group-hover'],
            },
            },
            plugins: [],
        };
</script>

</head>

<body class="h-full text-base-content">
    <!-- Header with green gradient background -->

    
   <!-- Enhanced Header -->
   <header class="site-header">
  <div class="header-container">
    <div class="header-left">
      <div class="header-logo">
        <img src="../Assets/lims.png" alt="Logo" class="main-logo">
        <img id="portalLogo" class="portal-logo">
      </div>
    </div>

    <nav class="header-nav">
  <a href="../index1.html" class="header-nav-item">Home</a>
  <a href="../map.html" class="header-nav-item">Agri Self Analysis</a>
  <a href="../vector.html" class="header-nav-item">GIS Analysis</a>

  <div class="dropdown1">
    <button class="header-nav-item dropdown-btn">
      Agri Services <i class="fa-solid fa-chevron-down"></i>
    </button>
    <div class="dropdown1-content">
      <a href="livestock.html" class="header-nav-item">Live Stocks Rate</a>
     <!--  <a href="dealers.html" class="header-nav-item">Dealers</a> -->
      <a href="bulk-water.html" class="header-nav-item">Bulk Water Requirement</a>
      <a href="fertilizer.html" class="header-nav-item">Fertilizer Requirement</a>
    </div>
  </div>
</nav>


    <button class="mobile-menu-button">
      <i class="fa-solid fa-bars"></i>
    </button>
  </div>

  <div class="mobile-menu">
    <a href="../index1.html">Home</a>
    <a href="../map.html">Agri Self Analysis</a>
    <a href="../vector.html">GIS Analysis</a>
    <details class="mobile-dropdown">
      <summary>Agri Services</summary>
      <a href="livestock.html">Live Stocks Rate</a>
      <a href="dealers.html">Dealers</a>
      <a href="bulk-water.html">Bulk Water Requirement</a>
      <a href="fertilizer.html">Fertilizer Requirement</a>
    </details>
  </div>
</header>





    <!-- Main content remains the same -->
    <main id="main" class="pt-20">
<div class="container1">
          <h2 class="text-3xl font-bold text-center mb-6  animate-fade-up color">üè™ Dealers Dashboard </h2>

 <div class="filters-section">
            <div class="filters-grid">
                <div class="filter-group">
                    <label for="provinceSelect">Province</label>
                    <select id="provinceSelect">
                        <option value="">Loading provinces...</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="divisionSelect">Division</label>
                    <select id="divisionSelect">
                        <option value="">Select Province First</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="districtSelect">District</label>
                    <select id="districtSelect">
                        <option value="">Select Division First</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="tehsilSelect">Tehsil</label>
                    <select id="tehsilSelect">
                        <option value="">Select District First</option>
                    </select>
                </div>
            </div>

            <button class="search-button" id="searchButton">üîç Search Dealers</button>
        </div>

        <div class="results-section">
            <div class="results-header">
                <div class="results-count" id="resultsCount">Ready to search</div>
            </div>

            <div id="loadingIndicator" class="loading" style="display: none;">
                Loading dealers...
            </div>

            <div id="errorMessage" class="error" style="display: none;"></div>

            <div id="dealersGrid" class="dealers-grid"></div>

            <div id="pagination" class="pagination" style="display: none;"></div>
        </div>
</div>
</main>
    <script>
        // Configuration - Updated token handling
        const API_BASE = 'https://farmerapp.limspakistan.org/db';
        // Note: This token may need to be refreshed periodically
        let BEARER_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzU2MzAzNDQ2LCJpYXQiOjE3NTQ1NzU0NDYsImp0aSI6IjUwYWZjMWUyYzc2MDRmYzk4NTJkMTk5YjlkZGUyMGZmIiwidXNlcl9pZCI6MjI0fQ.8pB3hQdgYw7rAs016MPnmhMzjKbgqxNhvoM2HdcbPkA';
        const ITEMS_PER_PAGE = 10;
    // Check if token is expired
        function isTokenExpired(token) {
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const currentTime = Math.floor(Date.now() / 1000);
                return payload.exp < currentTime;
            } catch (error) {
                return true;
            }
        }

        // Show token status
        function checkTokenStatus() {
            const expired = isTokenExpired(BEARER_TOKEN);
            if (expired) {
                showError('Authentication token has expired. Please contact administrator for a new token.');
            }
            return !expired;
        }

        // State
        let currentPage = 1;
        let totalPages = 1;
        let actualItemsPerPage = ITEMS_PER_PAGE;
        let hasNextPage = false;
        let currentFilters = {
            province: '',
            division: '',
            district: '',
            tehsil: ''
        };

        // DOM Elements
        const provinceSelect = document.getElementById('provinceSelect');
        const divisionSelect = document.getElementById('divisionSelect');
        const districtSelect = document.getElementById('districtSelect');
        const tehsilSelect = document.getElementById('tehsilSelect');
        const searchButton = document.getElementById('searchButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessage = document.getElementById('errorMessage');
        const dealersGrid = document.getElementById('dealersGrid');
        const pagination = document.getElementById('pagination');
        const resultsCount = document.getElementById('resultsCount');

        // API Helper
        async function apiCall(endpoint, retries = 3) {
            const cleanEndpoint = endpoint.startsWith('/api/dealers/?') ? endpoint : endpoint;
            
            if (!checkTokenStatus()) {
                throw new Error('Authentication token expired');
            }
            
            for (let attempt = 1; attempt <= retries; attempt++) {
                try {
                    const response = await fetch(`${API_BASE}${cleanEndpoint}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${BEARER_TOKEN}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        mode: 'cors'
                    });

                    if (response.status === 401) {
                        throw new Error('Authentication failed: Token expired or invalid');
                    }

                    // Handle 404 as "no data" for pagination
                    if (response.status === 404) {
                        return { 
                            results: [], 
                            count: 0, 
                            next: null, 
                            previous: null,
                            current_page: currentPage,
                            total_pages: currentPage - 1
                        };
                    }

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                    }

                    const data = await response.json();
                    return data;

                } catch (error) {
                    if (error.message.includes('Authentication failed') || error.message.includes('token expired')) {
                        throw error;
                    }
                    
                    if (attempt === retries) {
                        throw error;
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                }
            }
        }

        // Load Provinces
        async function loadProvinces() {
            try {
                if (!checkTokenStatus()) {
                    throw new Error('Token expired');
                }
        
                let response;
                try {
                    response = await apiCall('/chained/provinces/');
                } catch (error) {
                    response = [
                        { id: 1, name: 'Punjab' },
                        { id: 2, name: 'Sindh' },
                        { id: 3, name: 'Khyber Pakhtunkhwa' },
                        { id: 4, name: 'Balochistan' },
                        { id: 5, name: 'Islamabad Capital Territory' },
                        { id: 6, name: 'Azad Jammu and Kashmir' },
                        { id: 7, name: 'Gilgit-Baltistan' }
                    ];
                }
        
                provinceSelect.innerHTML = '<option value="">All Provinces</option>';
        
                const provinces = response.data || response;
        
                if (provinces && Array.isArray(provinces)) {
                    provinces.forEach(province => {
                        const option = document.createElement('option');
                        option.value = province.id;
                        option.textContent = province.name;
                        provinceSelect.appendChild(option);
                    });
                } else {
                    throw new Error('Invalid response format');
                }
        
            } catch (error) {
                if (error.message.includes('token expired') || error.message.includes('Authentication failed')) {
                    showError('Authentication token has expired. Please contact the administrator for a new access token.');
                } else {
                    showError('Failed to load provinces. Using offline mode.');
                }
        
                provinceSelect.innerHTML = `
                    <option value="">All Provinces</option>
                    <option value="1">Punjab</option>
                    <option value="2">Sindh</option>
                    <option value="3">Khyber Pakhtunkhwa</option>
                    <option value="4">Balochistan</option>
                `;
            }
        }

        // Load Divisions
        async function loadDivisions(provinceId) {
            if (!provinceId) {
                divisionSelect.innerHTML = '<option value="">Select Province First</option>';
                districtSelect.innerHTML = '<option value="">Select Division First</option>';
                tehsilSelect.innerHTML = '<option value="">Select District First</option>';
                return;
            }

            try {
                const response = await apiCall(`/chained/chain-division/?province=${provinceId}`);
                divisionSelect.innerHTML = '<option value="">All Divisions</option>';
                const divisions = response.data || response;
        
                if (divisions && Array.isArray(divisions)) {
                    divisions.forEach(division => {
                        const option = document.createElement('option');
                        option.value = division.id;
                        option.textContent = division.name;
                        divisionSelect.appendChild(option);
                    });
                }

                districtSelect.innerHTML = '<option value="">Select Division First</option>';
                tehsilSelect.innerHTML = '<option value="">Select District First</option>';
            } catch (error) {
                divisionSelect.innerHTML = '<option value="">Error loading divisions</option>';
            }
        }

        // Load Districts
        async function loadDistricts(divisionId) {
            if (!divisionId) {
                districtSelect.innerHTML = '<option value="">Select Division First</option>';
                tehsilSelect.innerHTML = '<option value="">Select District First</option>';
                return;
            }

            try {
                const response = await apiCall(`/chained/chain-district/?division=${divisionId}`);
                districtSelect.innerHTML = '<option value="">All Districts</option>';
                const districts = response.data || response;
        
                if (districts && Array.isArray(districts)) {
                    districts.forEach(district => {
                        const option = document.createElement('option');
                        option.value = district.id;
                        option.textContent = district.name;
                        districtSelect.appendChild(option);
                    });
                }

                tehsilSelect.innerHTML = '<option value="">Select District First</option>';
            } catch (error) {
                districtSelect.innerHTML = '<option value="">Error loading districts</option>';
            }
        }

        // Load Tehsils
        async function loadTehsils(districtId) {
            if (!districtId) {
                tehsilSelect.innerHTML = '<option value="">Select District First</option>';
                return;
            }

            try {
                const response = await apiCall(`/chained/chain-tehsil/?district=${districtId}`);
                tehsilSelect.innerHTML = '<option value="">All Tehsils</option>';
                const tehsils = response.data || response;
        
                if (tehsils && Array.isArray(tehsils)) {
                    tehsils.forEach(tehsil => {
                        const option = document.createElement('option');
                        option.value = tehsil.id;
                        option.textContent = tehsil.name;
                        tehsilSelect.appendChild(option);
                    });
                }
            } catch (error) {
                tehsilSelect.innerHTML = '<option value="">Error loading tehsils</option>';
            }
        }

        // Search Dealers
        async function searchDealers(page = 1) {
            showLoading(true);
            hideError();

            try {
                let endpoint;
                let useLocationFilter = currentFilters.tehsil || currentFilters.district || currentFilters.division || currentFilters.province;
                
                if (useLocationFilter) {
                    endpoint = `/api/dealers-by-tehsile/`;
                } else {
                    endpoint = `/api/dealers/`;
                }
                
                const params = new URLSearchParams();
                params.append('page', page);
                
                if (useLocationFilter) {
                    if (currentFilters.tehsil) {
                        params.append('tehsil', currentFilters.tehsil);
                    } else if (currentFilters.district) {
                        params.append('district', currentFilters.district);
                    } else if (currentFilters.division) {
                        params.append('division', currentFilters.division);
                    } else if (currentFilters.province) {
                        params.append('province', currentFilters.province);
                    }
                }
                
                const fullEndpoint = `${endpoint}?${params.toString()}`;
                const response = await apiCall(fullEndpoint);
                
                // Handle empty response
                if (!response.results || response.results.length === 0) {
                    if (page > 1) {
                        currentPage = page - 1;
                        totalPages = currentPage;
                        hasNextPage = false;
                        updatePagination({ 
                            count: 0, 
                            current_page: currentPage, 
                            total_pages: totalPages,
                            next: null,
                            previous: currentPage > 1 ? 'exists' : null
                        });
                        showLoading(false);
                        return;
                    } else {
                        displayDealers([]);
                        updatePagination({ count: 0, current_page: 1, total_pages: 1 });
                        updateResultsCount({ count: 0 });
                        showLoading(false);
                        return;
                    }
                }
                
                currentPage = page;
                actualItemsPerPage = response.results.length;
                hasNextPage = !!response.next || (response.results.length === ITEMS_PER_PAGE);
                
                if (response.total_pages) {
                    totalPages = response.total_pages;
                } else if (response.count) {
                    totalPages = Math.ceil(response.count / actualItemsPerPage);
                } else {
                    totalPages = hasNextPage ? currentPage + 1 : currentPage;
                }
                
                displayDealers(response.results);
                updatePagination(response);
                updateResultsCount(response);
                
            } catch (error) {
                showError(`Failed to load dealers: ${error.message}. Please try again.`);
                dealersGrid.innerHTML = '';
            } finally {
                showLoading(false);
            }
        }

        // Display Dealers
        function displayDealers(dealers) {
            if (!dealersGrid) {
                return;
            }
            
            if (!dealers || dealers.length === 0) {
                dealersGrid.innerHTML = `
                    <div class="no-results">
                        <h3>No dealers found</h3>
                        <p>Try adjusting your search criteria</p>
                    </div>
                `;
                return;
            }

            dealersGrid.innerHTML = '';
            
            try {
                const dealerCardsHTML = dealers.map((dealer, index) => {
                    const dealerName = dealer.name || `Dealer ${index + 1}`;
                    const dealerType = dealer.type || 'General';
                    const dealerAddress = dealer.address || 'Address not available';
                    const dealerPhone = dealer.mobile_number || dealer.phone || 'Phone not available';
                    
                    return `
                        <div class="dealer-card">
                            <div class="dealer-header">
                                <div class="dealer-icon">
                                    ${getTypeIcon(dealerType)}
                                </div>
                                <div>
                                    <div class="dealer-name">${dealerName}</div>
                                    <div class="dealer-type">${dealerType}</div>
                                </div>
                            </div>
                            <div class="dealer-info">
                                <div class="info-row">
                                    <span class="info-icon">üìç</span>
                                    <span>${dealerAddress}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-icon">üìû</span>
                                    <span>${dealerPhone}</span>
                                </div>
                               
                            </div>
                        </div>
                    `;
                }).join('');
                
                dealersGrid.innerHTML = dealerCardsHTML;
                dealersGrid.offsetHeight;
                
            } catch (error) {
                dealersGrid.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: red; border: 1px solid red; margin: 20px; border-radius: 8px;">
                        <h3>Error displaying dealers</h3>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Get Type Icon
        function getTypeIcon(type) {
            switch(type) {
                case 'Fertilizer': return 'üå±';
                case 'Seed': return 'üåæ';
                case 'Pesticide': return 'üõ°Ô∏è';
                default: return 'üè™';
            }
        }

        // Update Pagination
        function updatePagination(response) {
            const totalCount = response.count || 0;
            
            if (response.current_page) {
                currentPage = response.current_page;
            }
            
            if (response.total_pages) {
                totalPages = response.total_pages;
            } else {
                if (hasNextPage) {
                    totalPages = Math.max(totalPages, currentPage + 1);
                } else {
                    totalPages = currentPage;
                }
            }

            if (totalPages <= 1 && !hasNextPage) {
                pagination.style.display = 'none';
                return;
            }

            pagination.style.display = 'flex';

            const canGoFirst = currentPage > 1;
            const canGoPrevious = currentPage > 1;
            const canGoNext = hasNextPage && currentPage < totalPages;
            const canGoLast = hasNextPage && currentPage < totalPages;
            
            let paginationHTML = `
                <button ${!canGoFirst ? 'disabled' : ''} onclick="goToPage(1)">
                    ‚èÆÔ∏è First
                </button>
                <button ${!canGoPrevious ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">
                    ‚Üê Previous
                </button>
                <span class="current-page">Page ${currentPage}${totalPages > currentPage ? ` of ${totalPages}+` : ''}</span>
                <button ${!canGoNext ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">
                    Next ‚Üí
                </button>
                <button ${!canGoLast ? 'disabled' : ''} onclick="goToPage(${totalPages})">
                    Last ‚è≠Ô∏è
                </button>
            `;

            pagination.innerHTML = paginationHTML;
        }

        // Go to Page
        function goToPage(page) {
            const targetPage = Math.max(1, parseInt(page));
            
            if (targetPage > currentPage && !hasNextPage) {
                return;
            }
            
            if (targetPage !== currentPage) {
                searchDealers(targetPage);
            }
        }

        // Update Results Count
        function updateResultsCount(response) {
            const total = response.count || 0;
            const itemsOnPage = response.results ? response.results.length : 0;
            const start = ((currentPage - 1) * actualItemsPerPage) + 1;
            const end = ((currentPage - 1) * actualItemsPerPage) + itemsOnPage;
            
            let useLocationFilter = currentFilters.tehsil || currentFilters.district || currentFilters.division || currentFilters.province;
            let searchType = useLocationFilter ? '(Location Filtered)' : '(All Dealers)';
            
            if (total === 0 || itemsOnPage === 0) {
                resultsCount.textContent = `No dealers found ${searchType}`;
            } else if (total > 0) {
                resultsCount.textContent = `Showing ${start}-${end} of ${total} dealers ${searchType}`;
            } else {
                resultsCount.textContent = `Showing ${itemsOnPage} dealers on page ${currentPage} ${searchType}`;
            }
        }

        // Show Loading
        function showLoading(show) {
            loadingIndicator.style.display = show ? 'block' : 'none';
            if (show) {
                dealersGrid.innerHTML = '';
                pagination.style.display = 'none';
            }
        }

        // Show Error
        function showError(message) {
            let errorHtml = message;
            
            if (message.includes('token') || message.includes('Authentication')) {
                errorHtml += `
                    <br><br>
                    <strong>Token Issue Detected:</strong>
                    <br>‚Ä¢ The authentication token has expired
                    <br>‚Ä¢ Contact your administrator for a new token
                    <br>‚Ä¢ Or try using the offline mode below
                    <br><button class="retry-button" onclick="useOfflineMode()">üì± Use Offline Mode</button>
                `;
            } else {
                errorHtml += `<br><button class="retry-button" onclick="retryLastOperation()">üîÑ Retry</button>`;
            }
            
            errorMessage.innerHTML = errorHtml;
            errorMessage.style.display = 'block';
        }

        // Hide Error
        function hideError() {
            errorMessage.style.display = 'none';
        }

        // Retry last operation
        function retryLastOperation() {
            loadProvinces();
        }

        // Offline mode function
        function useOfflineMode() {
            hideError();
            
            const mockDealers = [
                {
                    id: 1,
                    name: "Green Valley Fertilizers",
                    type: "Fertilizer",
                    address: "Main Market, Lahore",
                    phone: "+92-42-1234567",
                    email: "info@greenvalley.pk",
                    tehsil_name: "Lahore"
                },
                {
                    id: 2,
                    name: "Premium Seeds Co.",
                    type: "Seed",
                    address: "Agricultural Complex, Faisalabad",
                    phone: "+92-41-9876543",
                    tehsil_name: "Faisalabad"
                },
                {
                    id: 3,
                    name: "Crop Protection Services",
                    type: "Pesticide",
                    address: "Farmers Market, Multan",
                    phone: "+92-61-5555555",
                    tehsil_name: "Multan"
                }
            ];
            
            displayDealers(mockDealers);
            resultsCount.textContent = `Showing ${mockDealers.length} dealers (Offline Mode)`;
            pagination.style.display = 'none';
        }

        // Auto-search when filters change
        function handleFilterChange() {
            currentPage = 1;
            hasNextPage = false;
            searchDealers(1);
        }

        // Event Listeners
        provinceSelect.addEventListener('change', (e) => {
            currentFilters.province = e.target.value;
            loadDivisions(e.target.value);
        });

        divisionSelect.addEventListener('change', (e) => {
            currentFilters.division = e.target.value;
            loadDistricts(e.target.value);
        });

        districtSelect.addEventListener('change', (e) => {
            currentFilters.district = e.target.value;
            loadTehsils(e.target.value);
        });

        tehsilSelect.addEventListener('change', (e) => {
            currentFilters.tehsil = e.target.value;
            handleFilterChange();
        });

        searchButton.addEventListener('click', () => {
            currentPage = 1;
            hasNextPage = false;
            searchDealers(1);
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkTokenStatus();
            loadProvinces();
            searchDealers(1);
        });
    </script>
   
       <!-- JavaScript for dropdown and mobile menu -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
    // Enhanced Dropdown Functionality
    const dropdownButton = document.getElementById('agriReqDropdown');
    const dropdownContent = document.querySelector('.dropdown1-content');
    const dropdownArrow = dropdownButton.querySelector('i');

    if (dropdownButton && dropdownContent && dropdownArrow) {
        dropdownButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            dropdownContent.classList.toggle('show');
            dropdownArrow.style.transform = dropdownContent.classList.contains('show') 
                ? 'rotate(180deg)' : 'rotate(0deg)';
        });
        
        document.addEventListener('click', function(e) {
            if (!dropdownButton.contains(e.target) && !dropdownContent.contains(e.target)) {
                dropdownContent.classList.remove('show');
                dropdownArrow.style.transform = 'rotate(0deg)';
            }
        });
    }

            // Mobile Menu
           const mobileMenuButton = document.getElementById('mobileMenuButton');
    const mobileMenu = document.getElementById('mobileMenu');
    const mobileMenuIcon = mobileMenuButton.querySelector('i');
    
    mobileMenuButton.addEventListener('click', function() {
        mobileMenu.classList.toggle('active');
        
        // Change hamburger to X icon
        if (mobileMenu.classList.contains('active')) {
            mobileMenuIcon.classList.remove('fa-bars');
            mobileMenuIcon.classList.add('fa-times');
        } else {
            mobileMenuIcon.classList.remove('fa-times');
            mobileMenuIcon.classList.add('fa-bars');
            // Close mobile dropdown when closing mobile menu
            const mobileAgriContent = document.getElementById('mobileAgriContent');
            const mobileChevron = document.querySelector('.mobile-chevron');
            if (mobileAgriContent && mobileChevron) {
                mobileAgriContent.classList.remove('show');
                mobileChevron.style.transform = 'rotate(0deg)';
            }
        }
    });

    // Mobile Dropdown (New Addition)
    const mobileAgriDropdown = document.getElementById('mobileAgriDropdown');
    const mobileAgriContent = document.getElementById('mobileAgriContent');
    const mobileChevron = document.querySelector('.mobile-chevron');
    
    if (mobileAgriDropdown && mobileAgriContent && mobileChevron) {
        mobileAgriDropdown.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            mobileAgriContent.classList.toggle('show');
            mobileChevron.style.transform = mobileAgriContent.classList.contains('show') 
                ? 'rotate(180deg)' : 'rotate(0deg)';
        });
    }
    
    // Close mobile menu when clicking on mobile menu links
    const mobileMenuLinks = document.querySelectorAll('.mobile-menu-item, .mobile-dropdown-item');
    mobileMenuLinks.forEach(link => {
        link.addEventListener('click', function() {
            mobileMenu.classList.remove('active');
            mobileMenuIcon.classList.remove('fa-times');
            mobileMenuIcon.classList.add('fa-bars');
            
            // Close mobile dropdown
            if (mobileAgriContent && mobileChevron) {
                mobileAgriContent.classList.remove('show');
                mobileChevron.style.transform = 'rotate(0deg)';
            }
        });
    });
    
    // Close mobile menu when clicking outside
    document.addEventListener('click', function(e) {
        if (mobileMenu && !mobileMenuButton.contains(e.target) && !mobileMenu.contains(e.target)) {
            mobileMenu.classList.remove('active');
            mobileMenuIcon.classList.remove('fa-times');
            mobileMenuIcon.classList.add('fa-bars');
            
            // Close mobile dropdown
            if (mobileAgriContent && mobileChevron) {
                mobileAgriContent.classList.remove('show');
                mobileChevron.style.transform = 'rotate(0deg)';
            }
        }
    });

    // Smooth scrolling for navigation links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
});
    </script>
    <script src="auth.js"></script>
<script src="logo.js"></script>
</body>
</html>
